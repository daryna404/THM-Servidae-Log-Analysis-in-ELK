# THM-Servidae-Log-Analysis-in-ELK
**Objectives**

Get familiar with the Elastic (ELK) Stack and its components.
Understand the significance of log data analysis in detecting and investigating security incidents.
Get introduced to Kibana and its key functionalities for data analysis, visualization, and exploration.
Gain hands-on experience with analyzing log data to identify real-world security threats and anomalies.

**Scenario**

Bill Smith, a senior Finance Executive at Servidae Industries, stated that he received an email from an unknown sender containing a PDF file attachment that required his action. At first glance, this email appeared legitimate, and he downloaded and opened it without any suspicion. After some time, Bill noticed his computer was acting abnormally and contacted IT Support, claiming that his workstation was slow and freezing up intermittently. Soon after, security alerts indicated suspicious network activity and unauthorized commands executed on Bill's workstation.

A copy of the security alert from the organization's Endpoint Detection & Response (EDR) solution reads:

This is an automated security alert generated by EndDefender EDR. Suspicious network activity and potential remote access were detected on workstation SERVIDAE-BOB-FIN-04 within the specified time range of: May 11, 2023 @ 18:45:00.000 to May 11, 2023 @ 19:01:00.000.

As a SOC Analyst at Servidae Industries, it's up to you to investigate the security alert by reviewing the logs to identify the cause and nature of the suspicious activity on Bill's computer. Fortunately, the organization recently implemented an Elastic Stack solution, and an Elastic Agent was installed to collect logs from Bill's workstation. We have access to the Kibana dashboard, which contains logs from the time of the incident. Let's walk through the investigation and determine if there were any signs of account compromise or malicious user activity.

# Task 5: Kibana – Fields and Values Investigation
  **1.Selecting Relevant Fields:**

I began by applying the desired time range to focus on logs that could be relevant to the attack on Bill’s workstation.
In the case of Bill's incident, we know that a malicious attacker potentially gained remote access to his workstation. Through this context, we can infer that the attacker likely ran commands on the system, attempted to elevate privileges, accessed files, attempted to maintain persistence, and more. Then, I selected key fields for investigation, including destination.ip, process.command_line, process.executable, and related.user. These fields provided critical insights into the attacker's actions.

![image](https://github.com/user-attachments/assets/e5ac624e-36c6-42b8-982e-3a91f0a7e180)


  **2.Identifying Suspicious IP:**
In Kibana, I examined the Top values for the destination.ip field to spot unusual or suspicious IP addresses.
I identified the IP address **84.237.252.156**, which stood out as a potential Command and Control (C2) server, because it's a public IP adress and all others are private. A lookup confirmed that this IP originated from Latvia.

![image](https://github.com/user-attachments/assets/3151a6e7-d43a-4151-8707-7e1b8814ad94)

  **3.Examining Frequent Processes:**
Next, I looked at the process.name field to see which processes were most frequently running on Bill’s workstation. This helped me identify suspicious activity linked to the attack. The frequent execution of **curl.exe** could be suspicious, as it may indicate the attacker is using it to interact with external servers, such as for downloading malicious payloads or sending stolen data. Therefore, it is a key piece of evidence suggesting malicious activity.

<img width="147" alt="image" src="https://github.com/user-attachments/assets/217b6878-7c8b-44e4-a5d3-cf1ac62d3921" />


# Task 6: Kibana – Sorting and Filtering Investigation
  **1. Sorting Logs Chronologically:**

I sorted the logs by timestamp (Old-New), ensuring I was looking at events from the beginning of the incident. This step allowed me to trace the sequence of actions taken by the attacker.

  **2.Filtering for Specific Events:**

To focus on commands executed during the attack, I filtered logs by the process.command_line field. This revealed events that had recorded command-line activities.
I also applied a filter to focus on Bill’s workstation by selecting SERVIDAE-BOB-FIN-04 under the agent.name field. Additionally, I filtered by the user bsmith to investigate actions performed by the compromised user.

<img width="474" alt="image" src="https://github.com/user-attachments/assets/fc7d7978-9ded-461b-a922-0fc0b40ae97b" />


`**3.Identifying Malicious Command Execution:**

After applying these filters, I examined the logs for command execution. One log entry indicated the execution of powershell.exe, which was a red flag as PowerShell is often used for malicious purposes.
Expanding the log entry revealed the command used by the attacker: a PowerShell script disguised as a PDF invoice (file extension .ps1), confirming that the attacker gained remote access using this script.

<img width="455" alt="image" src="https://github.com/user-attachments/assets/bbd70ed0-d932-4a66-8d83-9682a6769613" />


  **4.Investigating Process Details:**

I further explored the details of the log entry, which included the Process ID (PID) of the PowerShell script (6712) and its parent process, explorer.exe, which was likely used to spawn the malicious PowerShell process.

# Task 7 Indicators of Compromise: Discovery

  **1.Common discovery commands:**

The attacker ran whoami.exe, HOSTNAME.EXE, ipconfig.exe, NETSTAT.EXE, and tasklist.exe. These commands are typically used by system administrators to manage and troubleshoot systems, but in this context, they are indicators of compromise (IOCs).
The use of these commands suggests that the attacker was gathering information about the compromised workstation, possibly to assess the environment for further exploitation.

![image](https://github.com/user-attachments/assets/f0aad529-cf81-4502-a74f-b612b1a2d61f)


  **2.Automated Discovery with PowerShell:**

The attacker executed a PowerShell command (Invoke-WebRequest) to download a file named winPEASany.exe from a remote server (evilparrot.thm), saving it as winPEAS.exe. winPEAS is a tool used to enumerate privilege escalation paths on Windows systems, indicating the attacker was trying to identify potential vulnerabilities for escalating privileges.

![image](https://github.com/user-attachments/assets/e3f21311-d2b8-419e-abdb-e1d7b67a24db)


  **3.Registry Queries:**

After running winPEAS.exe, the attacker made registry queries to check for potential privilege escalation opportunities, particularly looking for the AlwaysInstallElevated entry in the Windows Registry. This is a well-known privilege escalation technique, and finding this entry would allow the attacker to run MSI files with elevated privileges.

<img width="859" alt="image" src="https://github.com/user-attachments/assets/1137ba18-4e00-4315-8f31-7de98b5a1a3b" />


# Task 8 Indicators of Compromise: Privilege Escalation

  **1. Exploitation of AlwaysInstallElevated:**

The attacker targeted the AlwaysInstallElevated registry entry, which, when set, allows a user to install programs with elevated privileges, even without admin rights. The attacker was likely searching for this setting to perform privilege escalation.

  **2.Use of Malicious MSI File:**
The attacker downloaded a malicious MSI file (adminshell.msi) using the PowerShell Invoke-WebRequest cmdlet. The file was executed using msiexec.exe, which could provide the attacker with an elevated shell (command-line access) on the compromised system.

![image](https://github.com/user-attachments/assets/92ee5e5c-dedb-47bc-9a00-3f0abef78375)


# Task 9 Indicators of Compromise: Persistence

 **1.Modifying Filters for Elevated Privileges**

In the previous task, I observed the attacker exploiting the AlwaysInstallElevated registry setting to gain an elevated command shell on Bill's workstation. To refine my investigation, I need to adjust our current filters.
Modified the related.user filter from bsmith to SYSTEM because elevated processes typically run under the SYSTEM account. This will allow me to focus on processes running with elevated privileges.

  **2.Persistence: Creating Administrator Accounts**

Looking at the histogram chart at the top of the dashboard, I noticed a small spike of activity around 18:54:00, which aligns with the time the attacker achieved elevated access. A histogram chart displays data frequency within time blocks, and each bar represents a separate time block. Clicking on the time block for 18:54:00 narrows down the results for further investigation.

At 18:54:04, we can see the attacker executed suspicious commands using the net user command, which is used to create and manage user accounts in Windows. By expanding the log event, we see the full command:

<img width="611" alt="image" src="https://github.com/user-attachments/assets/5ea3b2cd-050b-4660-a16c-2b48984688f2" />


This command creates a new user named "backdoor" with no expiration for the password and disables password changes. Immediately after this, the attacker runs the net localgroup Administrators command to add the newly created user to the local Administrators group, granting them elevated privileges:

net localgroup Administrators backdoor /add
These commands confirm that the attacker created a new administrative account, ensuring they can maintain privileged access to the compromised workstation.

  **3.Persistence: Task Scheduling**

At 18:56:30, the attacker uses the Invoke-WebRequest cmdlet to download a file named beacon.bat from the server http://evilparrot.thm. A .bat file is a batch script in Windows used to automate tasks. The name "beacon" suggests it could be part of a Command and Control (C2) mechanism, where the attacker communicates with the compromised system.

Subsequent logs show the execution of beacon.bat, followed by cURL commands, likely sending data to or receiving commands from the attacker's server.

![image](https://github.com/user-attachments/assets/a62bdf53-2d5a-4f37-9c22-549a700a6252)


At 18:57:00, we see the attacker use the schtasks.exe command to create a scheduled task named "Beacon," which runs beacon.bat every minute under the SYSTEM account:


schtasks /create /tn "Beacon" /tr "C:\Users\bsmith\Desktop\beacon.bat" /sc minute /mo 1 /ru "System"
This scheduled task ensures that the attacker's malicious script runs every minute, even after a reboot, providing a reliable method to maintain persistence on the system.

![image](https://github.com/user-attachments/assets/f3f4f1cb-ed91-4c95-9760-2ddd4cbd0fed)


  **4.Persistence: Registry Editing**

After the schtasks.exe event, we can observe the attacker modifying the Windows Registry. Using the reg add and reg query commands, the attacker adds a new entry to the "Run" key in the Registry:

reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "BackdoorShell" /t REG_SZ /d "C:\Users\bsmith\Desktop\adminshell.msi" /f
This registry modification ensures that the adminshell.msi file is executed automatically whenever Bill logs in. As we know, this file is malicious and used to establish a remote shell with elevated permissions, further solidifying the attacker's persistence.

![image](https://github.com/user-attachments/assets/dc8cdba0-2abc-4cb4-bfa5-cf20bb80e7e0)


# Task 10: Indicators of Compromise – Lateral Movement

  **1.Network Enumeration**

An early sign of lateral movement in this scenario is found in the log event where the attacker used the following command:

<img width="434" alt="image" src="https://github.com/user-attachments/assets/bb527a17-03e8-4cf2-b568-27988c904b8d" />

The ping command tests connectivity between devices via the ICMP protocol. Although not inherently malicious, it suggests reconnaissance when viewed alongside other suspicious activity. The target, payroll.servidae.internal, is an internal payroll tool, likely containing sensitive information.

  **2.Lateral Movement: Accessing Internal Resources**
To analyze the attack further, the time range in Kibana was adjusted to start at May 11, 2023 @ 18:57:30.000. This revealed several curl requests targeting the internal payroll system at:

![image](https://github.com/user-attachments/assets/e250b20f-66ac-4726-bd9f-b0fec174a943)

  **3.Filtering Logs**

Using the following Kibana Query Language (KQL) query, unnecessary repeating logs were excluded to focus on relevant curl events:

<img width="325" alt="image" src="https://github.com/user-attachments/assets/3a6d06d1-d25d-4177-85a4-577c8ceb2a76" />

This query filters logs for processes using curl.exe but excludes those related to the attacker's "beacon" backdoor. The refined logs revealed that the attacker attempted to brute-force login credentials.

  **4.Internal Server Brute-Force**

The logs show a brute-force attack against the payroll server, with repeated login attempts using the bsmith username and incrementing password attempts (e.g., password=Pass3, password=Pass4). The development team confirmed that successful logins generate a session cookie (PHPSESSID). Using the query:

<img width="468" alt="image" src="https://github.com/user-attachments/assets/058e1d01-a174-40ad-b481-3f855aa1f1fa" />

![image](https://github.com/user-attachments/assets/45fc64be-3772-4ce4-b837-6feddf133659)

![image](https://github.com/user-attachments/assets/548bae6e-8fd7-4dc3-8333-b29413e73a44)

Identified two successful logins by the attacker.

  **5.Internal Server Data Exfiltration**

After authenticating, the attacker accessed sensitive resources on the payroll server. Using the following query:

<img width="339" alt="image" src="https://github.com/user-attachments/assets/176876d9-8277-4b83-8a3b-83b4391fad58" />

Three key log events were identified:

<img width="439" alt="image" src="https://github.com/user-attachments/assets/99b7a0c3-06ec-455f-91d2-3cce2eef83bf" />

![image](https://github.com/user-attachments/assets/2a273b30-33c3-4420-bf9e-593b389e0936)

Access to /employee-payroll.php, likely containing sensitive payroll data.
Download of a CSV file named bank-details.csv.
The final result in our logs shows that the attacker downloaded a potentially sensitive CSV file after gaining access to the payroll server. It was saved to Bill's desktop, which, if investigated chronologically without the current filters, is immediately followed by the "FTP" (File Transfer Protocol) command, likely to exfiltrate and transfer the stolen document back over to the attacker's system.
